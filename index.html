<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Login</title>

<style>
body{
margin:0;
font-family:Arial, sans-serif;
background:#f5f5f5;
}

/* ===== LOGIN ===== */
#loginBox{
max-width:350px;
margin:190px auto;
background:#fff;
padding:40px;
border-radius:100px;
box-shadow:0 2px 8px rgba(0,0,0,0.2);
}

#loginBox h2{
text-align:center;
color:#ff6600;
}

input{
width:93%;
padding:10px;
margin:10px 0;
border-radius:6px;
border:1px solid #ccc;
}

button{
width:100%;
padding:10px;
background:#ff6600;
color:#fff;
border:none;
border-radius:6px;
font-size:16px;
}

/* ===== ADMIN ===== */
#adminPanel{
display:none;
}

header{
background:#ff6600;
color:#fff;
padding:15px;
text-align:center;
font-size:20px;
}

nav{
display:flex;
background:#fff;
border-bottom:1px solid #ddd;
}

nav button{
flex:1;
padding:12px;
border:none;
background:none;
font-size:12px;
width:auto;
}
.action-btn{
width:100%;
padding:10px;
background:#ff6600;
color:#fff;
border:none;
border-radius:6px;
font-size:16px;
cursor:pointer;
}

nav button.active{
color:#ff6600;
font-weight:bold;
border-bottom:2px solid #ff6600;
}

section{
display:none;
padding:15px;
}

section.active{
display:block;
}

.card{
background:#fff;
padding:12px;
border-radius:10px;
margin-bottom:12px;
box-shadow:0 2px 5px rgba(0,0,0,0.1);
}

.logout{
background:red;
margin:10px;
}
button:hover{
opacity:0.9;
}

button:active{
transform:scale(0.98);
}
/* ===== DASHBOARD ===== */
.dash-grid{
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(160px,1fr));
  gap:15px;
}

.dash-card{
  background:#fff;
  padding:20px;
  border-radius:16px;
  box-shadow:0 4px 10px rgba(0,0,0,0.08);
}

.dash-card h4{
  margin:0 0 10px;
  font-size:16px;
}

.dash-value{
  font-size:32px;
  font-weight:bold;
}
/* ===== STATUS BADGE ===== */
.badge{
  padding:4px 10px;
  border-radius:20px;
  font-size:12px;
  font-weight:bold;
  color:#fff;
}

.badge.pending{ background:#f1c40f; }
.badge.checking{ background:#3498db; }
.badge.paid{ background:#2ecc71; }
.badge.ship{ background:#9b59b6; }
.badge.cancel{ background:#e74c3c; }
.badge.expire{ background:#7f8c8d; }

</style>
</head>
<body>

<div id="loading" style="text-align:center;padding:50px;">
‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
</div>
<!-- ===== LOGIN ===== -->
<div id="loginBox">
<h2>ùïæùñôùñÜùñôùñéùñîùñì ùï∂ùñéùñìùñå</h2>
<input type="email" id="user" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô">
<input type="password" id="pass" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
<button onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
</div>

<!-- ===== ADMIN PANEL ===== -->
<div id="adminPanel">

<header>
‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô
<button class="logout" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
</header>

<nav>
<button class="active" onclick="openTab('dashboard',this)">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
<button onclick="openTab('product',this)">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
<button onclick="openTab('order',this)">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
<button onclick="openTab('payment',this)">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
<button onclick="openTab('contact',this)">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</button>
</nav>
<section id="dashboard" class="active">
  <div style="margin-bottom:15px;">
  <button onclick="setRange('today')">üìÖ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
  <button onclick="setRange('yesterday')">‚è™ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô</button>
  <button onclick="setRange('month')">üìÜ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>

  <!-- ‡∏õ‡∏∏‡πà‡∏° Export -->
  <button onclick="exportPaidOrders()">üì§ Export (Paid)</button>
</div>
<canvas id="salesChart" height="120"></canvas>

  <div class="dash-grid">
    
    <div class="dash-card">
  <h4>üí∞ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß)</h4>
  <div class="dash-value" id="totalSales">0</div>
</div>
<div class="dash-card">
  <h4>üìà ‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</h4>
  <div class="dash-value" id="totalProfit">0</div>
</div>

<div class="dash-card">
  <h4>üü¢ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</h4>
  <div class="dash-value" id="paidCount">0</div>
</div>

<div class="dash-card">
  <h4>üîµ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ</h4>
  <div class="dash-value" id="checkingCount">0</div>
</div>

<div class="dash-card">
  <h4>üü° ‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h4>
  <div class="dash-value" id="pendingCount">0</div>
</div>

  </div>

</section>

<section id="product">
  <hr>
<h3>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏£‡πâ‡∏≤‡∏ô</h3>
<input type="file" id="logoFile" accept="image/*">
<button class="action-btn" onclick="uploadLogo()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÉ‡∏´‡∏°‡πà</button>
<hr>
<div class="card">
<h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>

<input id="pname" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
<input id="pscent" placeholder="‡∏Å‡∏•‡∏¥‡πà‡∏ô">
<input type="number" id="pprice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤">
<input type="number" id="pcost" placeholder="‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
<input type="number" id="pstock" placeholder="‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠">
<input type="number" id="psold" placeholder="‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß">
<input type="file" id="pimg">

<button class="action-btn" onclick="addProduct()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
<hr>
<h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
<div id="productList"></div>

</div>
</section>

<section id="order">
<div class="card">
<h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h3>
<div style="margin-bottom:10px;">
  <button onclick="setOrderFilter('all')">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  <button onclick="setOrderFilter('‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô')">‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
  <button onclick="setOrderFilter('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
  <button onclick="setOrderFilter('‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß')">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</button>
</div>
<div id="orderList"></div>
</div>
</section>

<section id="payment">
<div class="card">
<h3>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h3>

<input id="pay_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ">
<input id="pay_bank" placeholder="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£">
<input id="pay_number" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ">
<input type="file" id="pay_qr" accept="image/*">

<button class="action-btn" onclick="savePayment()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
</div>
</section>

<section id="contact">
<div class="card">
<h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</h3>

<input id="con_phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£">
<input id="con_line" placeholder="LINE">

<button class="action-btn" onclick="saveContact()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
</div>
</section>

</div>


<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const firebaseConfig = {
¬†¬†apiKey: "AIzaSyD_PEsWuy3Ad7Wfl6V1KmLYUxX_V5MDxto",
¬†¬†authDomain: "openking-shop.firebaseapp.com",
¬†¬†databaseURL: "https://openking-shop-default-rtdb.firebaseio.com",
¬†¬†projectId: "openking-shop",
¬†¬†storageBucket: "openking-shop.appspot.com",
¬†¬†messagingSenderId: "408359377995",
¬†¬†appId: "1:408359377995:web:32f3c2b29a06fa01abc1ce"
};

if(!firebase.apps.length){
  firebase.initializeApp(firebaseConfig);
}

const auth = firebase.auth();
const db = firebase.database();

// ===== DASHBOARD DATE RANGE =====
auth.onAuthStateChanged(function(user){

  const loading = document.getElementById("loading");

  if(loading){
    loading.style.display = "none";
  }

  if(user){
    db.ref("users/"+user.uid+"/role").once("value").then(snap=>{
      if(snap.val()==="admin"){
        document.getElementById("loginBox").style.display="none";
        document.getElementById("adminPanel").style.display="block";
      }else{
        auth.signOut();
      }
    });
  }
});

</script>
<script>
// ===== LOGIN ADMIN ‡∏î‡πâ‡∏ß‡∏¢ Firebase =====
function login(){

  let u = document.getElementById("user").value.trim();
  let p = document.getElementById("pass").value.trim();

  if(!u.includes("@")){
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    return;
  }

  auth.signInWithEmailAndPassword(u,p)
  .then((cred)=>{
    return db.ref("users/"+cred.user.uid+"/role").once("value");
  })
  .then((snapshot)=>{

    if(snapshot.val()!=="admin"){
  alert("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô");
  auth.signOut();
}

  })
  .catch((err)=>{
    alert("Error: "+err.message);
  });

}

// ===== LOGOUT =====
function logout(){
  auth.signOut().then(()=>{
    document.getElementById("loginBox").style.display="block";
    document.getElementById("adminPanel").style.display="none";
  });
}

// ===== ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ =====
function addProduct(){

let name = document.getElementById("pname").value;
let scent = document.getElementById("pscent").value;
let price = Number(document.getElementById("pprice").value);
let cost  = Number(document.getElementById("pcost").value) || 0;
let stock = Number(document.getElementById("pstock").value);
let sold  = Number(document.getElementById("psold").value) || 0;
let file  = document.getElementById("pimg").files[0];

if(!name || !price || !file){
  alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö");
  return;
}

let reader = new FileReader();

reader.onload = function(e){

  let base64Image = e.target.result;

  db.ref("products").push({
    name:name,
    scent:scent,
    price:price,
    cost:cost,
    stock:stock,
    sold:sold,
    img:base64Image
  });

  alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
  loadProductAdmin();

  document.getElementById("pname").value="";
  document.getElementById("pscent").value="";
  document.getElementById("pprice").value="";
  document.getElementById("pcost").value="";
  document.getElementById("pstock").value="";
  document.getElementById("psold").value="";
  document.getElementById("pimg").value="";
}

reader.readAsDataURL(file);

}

// ===== ‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö =====
function openTab(id, el){
¬†¬†let sec = document.querySelectorAll("section");
¬†¬†let btn = document.querySelectorAll("nav button");

¬†¬†sec.forEach(s => s.classList.remove("active"));
¬†¬†btn.forEach(b => b.classList.remove("active"));

¬†¬†document.getElementById(id).classList.add("active");
¬†¬†el.classList.add("active");
}

// ===== ORDER FILTER SYSTEM =====
let currentOrderFilter = "all";

function setOrderFilter(status){
  currentOrderFilter = status;
  loadOrders();
}

function loadOrders(){

  db.ref("orders").on("value", function(snapshot){

    document.getElementById("orderList").innerHTML="";

    snapshot.forEach(function(child){

      let o = child.val();

      // üîé ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
      if(currentOrderFilter !== "all" && o.status !== currentOrderFilter){
        return;
      }

      let badgeClass = "";

      if(o.status==="‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô") badgeClass="pending";
      if(o.status==="‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö") badgeClass="checking";
      if(o.status==="‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß") badgeClass="paid";
      if(o.status==="‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß") badgeClass="ship";
      if(o.status==="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß") badgeClass="cancel";
      if(o.status==="‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤") badgeClass="expire";

      let itemsHTML="";

      if(o.items){
        o.items.forEach(function(i){
          itemsHTML += `<li>${i.name} x ${i.qty} = ${i.price*i.qty} ‡∏ö‡∏≤‡∏ó</li>`;
        });
      }

      document.getElementById("orderList").innerHTML += `
      <div class="card">
        <p><b>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</b> ${o.customer}</p>
        <p><b>‡πÇ‡∏ó‡∏£:</b> ${o.phone}</p>
        <p><b>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</b> ${o.address}</p>

        <ul>${itemsHTML}</ul>

        <p><b>‡∏¢‡∏≠‡∏î:</b> ${o.total || 0} ‡∏ö‡∏≤‡∏ó</p>

        <p>
          <span class="badge ${badgeClass}">${o.status}</span>
        </p>

        <p><b>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b>
          <select onchange="updateStatus('${child.key}', this.value)">
            <option value="‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô" ${o.status=="‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô"?"selected":""}>‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</option>
            <option value="‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö" ${o.status=="‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö"?"selected":""}>‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</option>
            <option value="‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß" ${o.status=="‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß"?"selected":""}>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option>
            <option value="‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß" ${o.status=="‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß"?"selected":""}>‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</option>
            <option value="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß" ${o.status=="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß"?"selected":""}>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß</option>
          </select>
        </p>

        ${
          o.slip
          ? `<img src="${o.slip}" style="width:200px;border-radius:8px">`
          : `<p style="color:red">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ</p>`
        }

        <button onclick="deleteOrder('${child.key}')">‡∏•‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
      </div>
      `;
    });

  });

}

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
loadOrders();

// ===== ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ =====
function updateStatus(orderId, newStatus){

  const orderRef = db.ref("orders/"+orderId);

  orderRef.once("value").then(snapshot=>{

    const order = snapshot.val();
    if(!order) return;

    // ===== ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß" =====
if(newStatus === "‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß" && !order.counted){

  let orderProfit = 0;
  let promises = [];

  order.items.forEach(item=>{

    const productRef = db.ref("products/"+item.id);

    const promise = productRef.transaction(p=>{

      if(!p) return;

      let stock = Number(p.stock) || 0;
      let sold  = Number(p.sold) || 0;

      if(stock < item.qty){
  alert("‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏≠!");
  return p; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏•‡∏±‡∏ö
}

      p.stock = stock - item.qty;
      p.sold  = sold + item.qty;

      const price = Number(p.price) || 0;
      const cost  = Number(p.cost) || 0;

      orderProfit += (price - cost) * item.qty;

      return p;

    });

    promises.push(promise);

  });

  Promise.all(promises).then(()=>{

  if(orderProfit < 0) orderProfit = 0;

  db.ref("orders/"+orderId).update({
    profit: Number(orderProfit) || 0,
    counted: true,
    status: "‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß",
    paidTime: Date.now()
  });

});

}

// ===== ‡∏ñ‡πâ‡∏≤‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏¢‡∏ï‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß =====
if(newStatus === "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß" && order.counted){

  if(order.items){
    order.items.forEach(item=>{

      const productRef = db.ref("products/"+item.id);

      productRef.once("value").then(psnap=>{
        const p = psnap.val();
        if(!p) return;

        const newStock = (Number(p.stock)||0) + item.qty;
        const newSold  = (Number(p.sold)||0) - item.qty;

        productRef.update({
          stock: newStock,
          sold: newSold < 0 ? 0 : newSold
        });

      });

    });
  }

  db.ref("orders/"+orderId).update({
    counted: false,
    profit: 0
  });

}

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
    orderRef.update({
      status: newStatus,
      paidTime: newStatus==="‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß" ? Date.now() : order.paidTime || null
    });

  });
}
// ===== ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô =====
function loadProductAdmin(){

db.ref("products").once("value", snapshot=>{
  document.getElementById("productList").innerHTML="";

  snapshot.forEach(child=>{
    let p = child.val();

    document.getElementById("productList").innerHTML += `
      <div class="card">
        <p><b>‡∏ä‡∏∑‡πà‡∏≠:</b> ${p.name}</p>
        <p><b>‡∏Å‡∏•‡∏¥‡πà‡∏ô:</b> ${p.scent}</p>
        <p><b>‡∏£‡∏≤‡∏Ñ‡∏≤:</b> ${p.price}</p>
        <p><b>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</b> ${p.stock}</p>

        <button onclick="editProduct('${child.key}',
        '${p.name}','${p.scent}','${p.price}','${p.stock}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>

        <button onclick="deleteProduct('${child.key}')">‡∏•‡∏ö</button>
      </div>
    `;
  });
});

}
loadProductAdmin();
// ===== ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ =====
function deleteProduct(id){
  if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")){
    db.ref("products/"+id).remove();
    loadProductAdmin();
  }
}

// ===== ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ =====
function editProduct(id,name,scent,price,stock){

  let newName = prompt("‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤",name);
  let newScent = prompt("‡∏Å‡∏•‡∏¥‡πà‡∏ô",scent);
  let newPrice = prompt("‡∏£‡∏≤‡∏Ñ‡∏≤",price);
  let newStock = prompt("‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠",stock);

  if(newName && newPrice){
    db.ref("products/"+id).update({
  name:newName,
  scent:newScent,
  price:Number(newPrice),
  stock:Number(newStock)
});

    loadProductAdmin();
  }

}
function uploadLogo(){

let file = document.getElementById("logoFile").files[0];

if(!file){
  alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÇ‡∏•‡πÇ‡∏Å‡πâ");
  return;
}

if(file.size > 2 * 1024 * 1024){
  alert("‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 2MB");
  return;
}

let reader = new FileReader();

reader.onload = function(e){

  let base64Logo = e.target.result;

  db.ref("shop/logo").set(base64Logo);

  alert("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
  document.getElementById("logoFile").value="";

}

reader.readAsDataURL(file);

}
// ===== ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô =====
function savePayment(){

let name = document.getElementById("pay_name").value;
let bank = document.getElementById("pay_bank").value;
let number = document.getElementById("pay_number").value;
let qrFile = document.getElementById("pay_qr").files[0];

if(!name || !bank || !number){
  alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
  return;
}

if(qrFile){
  let reader = new FileReader();
  reader.onload = function(e){
    db.ref("payment").set({
      name: name,
      bank: bank,
      number: number,
      qr: e.target.result
    });
    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
  }
  reader.readAsDataURL(qrFile);
}else{
  db.ref("payment").update({
    name: name,
    bank: bank,
    number: number
  });
  alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
}

}

// ===== ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ =====
function saveContact(){

let phone = document.getElementById("con_phone").value;
let line = document.getElementById("con_line").value;

if(!phone || !line){
  alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
  return;
}

db.ref("contact").set({
  phone:phone,
  line:line
}).then(()=>{

  alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß");

  document.getElementById("con_phone").value="";
  document.getElementById("con_line").value="";

});

}
let rangeStart = null;
let rangeEnd = null;
let salesChart = null;

function setRange(type){
  const now = new Date();

  if(type==="today"){
    rangeStart = new Date(now.setHours(0,0,0,0)).getTime();
    rangeEnd   = new Date(now.setHours(23,59,59,999)).getTime();
  }

  if(type==="yesterday"){
    const y = new Date();
    y.setDate(y.getDate()-1);
    rangeStart = new Date(y.setHours(0,0,0,0)).getTime();
    rangeEnd   = new Date(y.setHours(23,59,59,999)).getTime();
  }

  if(type==="month"){
    const m = new Date();
    rangeStart = new Date(m.getFullYear(), m.getMonth(), 1).getTime();
    rangeEnd   = new Date(m.getFullYear(), m.getMonth()+1, 0, 23,59,59).getTime();
  }

  loadDashboard();
}
function renderChart(dataMap){

  const labels = Object.keys(dataMap);
  const values = Object.values(dataMap);

  const ctx = document.getElementById("salesChart");

  if(salesChart){
    salesChart.destroy();
  }

  salesChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)",
        data: values
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}
// ===== DASHBOARD REALTIME (COMPAT FIX) =====
function loadDashboard(){

  db.ref("orders").on("value", function(snapshot){

    let pending = 0;
let checking = 0;
let paid = 0;
let totalSales = 0;
let totalProfit = 0;

    snapshot.forEach(function(child){

  let order = child.val();

  // ===== ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà =====
  if(rangeStart && rangeEnd){
    if(!order.paidTime || order.paidTime < rangeStart || order.paidTime > rangeEnd){
      return;
    }
  }

  if(order.status === "‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô"){
      pending++;
  }

  else if(order.status === "‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö"){
      checking++;
  }

  else if(
  order.status === "‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß" ||
  order.status === "‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß"
){
      paid++;
      totalSales += order.total || 0;
      totalProfit += order.profit || 0;
  }

});

    document.getElementById("pendingCount").innerText = pending;
    document.getElementById("checkingCount").innerText = checking;
    document.getElementById("paidCount").innerText = paid;
    document.getElementById("totalSales").innerText = totalSales.toLocaleString();
    document.getElementById("totalProfit").innerText = totalProfit.toLocaleString();

  });

}
loadDashboard();

/* ===== EXPORT PAID ORDERS ===== */
function exportPaidOrders(){

  db.ref("orders").once("value", snapshot=>{

    let csv = "OrderID,Customer,Phone,Total,Status,Date\n";

    snapshot.forEach(child=>{
      const o = child.val();

      if(o.status==="‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß" || o.status==="‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß"){

        const date = o.time
          ? new Date(o.time).toLocaleString("th-TH")
          : "";

        csv += `${child.key},${o.customer || ""},${o.phone || ""},${o.total || 0},${o.status},${date}\n`;
      }
    });

    downloadCSV(csv,"report_paid_orders.csv");
  });
}

function downloadCSV(csv, filename){

  const blob = new Blob(
    ["\uFEFF" + csv],
    { type: "text/csv;charset=utf-8;" }
  );

  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.setAttribute("download", filename);

  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
// ===== ‡∏•‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå =====
function deleteOrder(orderId){

  if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

  db.ref("orders/"+orderId).remove()
  .then(()=>{
    alert("‡∏•‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
  })
  .catch(err=>{
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: "+err.message);
  });

}
// ===== ORDER SOUND NOTIFICATION =====
let firstLoad = true;

const audio = new Audio("https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg");

db.ref("orders").limitToLast(1).on("child_added", function(snapshot){

  if(firstLoad){
    firstLoad = false;
    return;
  }

  audio.play();

  alert("üîî ‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤!");
});
// ===== AUTO EXPIRE ORDERS (ADMIN SIDE) =====
function autoExpireOrders(){
  db.ref("orders").once("value", snapshot=>{
    snapshot.forEach(child=>{
      let o = child.val();

      if(
        o.status === "‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô" &&
        o.expireAt &&
        Date.now() > o.expireAt
      ){
        db.ref("orders/"+child.key).update({
          status: "‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤"
        });
      }

    });
  });
}

// ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏∏‡∏Å 1 ‡∏ô‡∏≤‡∏ó‡∏µ
setInterval(autoExpireOrders, 60000);
</script>
</body>
</html>